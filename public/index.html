<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>makala.ai</title>
<link rel="icon" href="/makala.ico" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Markdown + sanitize + KaTeX -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>

<style>
/* ----------------- base & theme variables ----------------- */
*{box-sizing:border-box}
:root{
  --font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  --bg1:#0a0015; --bg2:#1b001f;
  --accent-a:#ff49a0; --accent-b:#ff7fcf;
  --muted:#b9a9b7;
  --user-a:#200023; --user-b:#0b0012; --bot-bg: rgba(255,255,255,0.03);
}
html,body{height:100%;margin:0;font-family:var(--font);color:#fff;overflow-x:hidden}
body{display:flex;align-items:center;justify-content:center;padding:28px;background:radial-gradient(700px 500px at 10% 10%, rgba(255,79,160,0.06), transparent),linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}

/* themes set variables so CSS auto-updates */
body.theme-pink{--bg1:#0a0015;--bg2:#1b001f;--accent-a:#ff49a0;--accent-b:#ff7fcf;--user-a:#200023;--user-b:#0b0012;--bot-bg:rgba(255,255,255,0.03)}
body.theme-deep{--bg1:#020202;--bg2:#000;--accent-a:#ff007f;--accent-b:#ff4fb1;--user-a:#0b0b0b;--user-b:#000000;--bot-bg:rgba(255,255,255,0.02)}
body.theme-soft{--bg1:#0b0710;--bg2:#1b1128;--accent-a:#b98cff;--accent-b:#8fb7ff;--user-a:#161023;--user-b:#0b0620;--bot-bg:rgba(255,255,255,0.035)}
body.theme-blue{--bg1:#041025;--bg2:#061b2f;--accent-a:#2ea6ff;--accent-b:#7ecbff;--user-a:#042033;--user-b:#001426;--bot-bg:rgba(255,255,255,0.02)}
body.theme-orange{--bg1:#130800;--bg2:#2a0f00;--accent-a:#ff9a3c;--accent-b:#ff5a1f;--user-a:#2b0f00;--user-b:#1a0700;--bot-bg:rgba(255,255,255,0.02)}

body.theme-pink, body.theme-deep, body.theme-soft, body.theme-blue, body.theme-orange {
  transition: background 280ms ease, color 200ms ease;
}

/* ----------------- layout ----------------- */
.app{width:980px;max-width:calc(100% - 40px);height:720px;display:grid;grid-template-columns:240px 1fr;gap:18px;align-items:start}
.sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;height:100%;box-shadow:0 12px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column}
.sidebar header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.new-btn{margin-left:auto;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;cursor:pointer;transition:box-shadow .18s, transform .12s}
.new-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,0.35)}
.conv-list{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px}
.conv{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;cursor:pointer;color:var(--muted);transition:background .18s, box-shadow .18s}
.conv.active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.4)}

/* relative time small */
.conv-meta{font-size:12px;color:var(--muted)}

/* ----------------- panel ----------------- */
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;height:100%;display:flex;flex-direction:column;box-shadow:0 12px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);overflow:hidden}
.header{display:flex;align-items:center;gap:12px;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.03)}
.brand{display:flex;align-items:center;gap:10px}
.brand img{width:28px;height:28px;border-radius:6px;transition:transform .22s ease, box-shadow .22s ease}
.brand img:hover{transform:scale(1.06);box-shadow:0 10px 30px rgba(255,73,160,0.12)}
.brand h1{margin:0;font-size:16px;font-weight:600;color:#fff}
.header-right{margin-left:auto;display:flex;gap:8px;align-items:center}

/* ----------------- messages ----------------- */
.messages-wrap{flex:1;overflow:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth;overflow-x:hidden}

/* BOT messages (no visible bubble) */
.bot-card{max-width:78%;display:flex;flex-direction:column;gap:6px;align-items:flex-start}
.bot-meta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
.bot-meta img{width:20px;height:20px;border-radius:6px;transition:box-shadow .18s}
.bot-label{font-weight:600;color:#fff;font-size:13px}
.bot-body{padding:0;color:#fff;white-space:pre-wrap;line-height:1.25;font-size:14px;position:relative;overflow:visible;word-break:break-word;margin:0}
.bot-inline-copy{display:inline-block;margin-left:8px;vertical-align:middle;cursor:pointer;padding:2px;border-radius:6px;background:rgba(255,255,255,0.02);transition:transform .12s, box-shadow .18s, opacity .16s;opacity:0.98}
.bot-inline-copy:hover{transform:scale(1.06);box-shadow:0 10px 30px rgba(0,0,0,0.45)}

/* CODE block & copy */
pre.code-block{position:relative;background:#0b0b10;padding:10px;border-radius:8px;overflow:auto;margin:8px 0;font-family:ui-monospace,Menlo,Monaco,'Roboto Mono',monospace;font-size:13px;color:#e6edf3}
.copy-code{position:absolute;right:8px;top:8px;width:28px;height:28px;cursor:pointer;border-radius:6px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;transition:transform .12s}
.copy-code:hover{transform:scale(1.06)}

/* USER bubbles (use variables so theme updates them) */
.row-user{display:flex;justify-content:flex-end}
.user-bubble{
  background:linear-gradient(90deg,var(--user-a),var(--user-b));
  color:#ffdff4;padding:10px 14px;border-radius:14px 14px 6px 14px;max-width:48%;min-width:80px;
  box-shadow:0 6px 18px rgba(0,0,0,0.6);position:relative;white-space:pre-wrap;line-height:1.25;font-size:14px;overflow-wrap:break-word;margin:0;transition:box-shadow .18s, transform .12s;
}
.row-user:hover .user-bubble{box-shadow:0 14px 40px rgba(0,0,0,0.45)}
.user-bubble .copy-user{position:absolute;right:-36px;top:6px;width:26px;height:26px;opacity:0;transition:opacity .18s;cursor:pointer}
.row-user:hover .user-bubble .copy-user{opacity:1}

/* user appear animation */
.user-appear{animation:flyIn .36s cubic-bezier(.2,.9,.27,1)}
@keyframes flyIn{0%{opacity:0;transform:translateY(12px) translateX(40px) scale(.98)}60%{opacity:1;transform:translateY(-4px) translateX(-6px) scale(1.02)}100%{opacity:1;transform:none}}

/* bot per-character reveal */
.bot-char{display:inline-block;opacity:0;transform:translateY(4px);animation:charIn .06s forwards}
@keyframes charIn{to{opacity:1;transform:none}}

/* fix markdown margin inside bot-body */
.bot-body p, .bot-body div, .bot-body pre, .bot-body ul, .bot-body ol, .bot-body blockquote, .bot-body h1, .bot-body h2, .bot-body h3{margin:0;padding:0;display:block;width:100%;vertical-align:top;white-space:pre-wrap}

/* ----------------- input & send ----------------- */
.input-area{padding:12px;border-top:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:10px}
.input-wrap{position:relative;flex:1}
textarea.input{width:100%;min-height:44px;max-height:200px;resize:none;padding:12px 44px 12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;font-size:14px;line-height:1.25}
textarea.input:focus{box-shadow:0 12px 28px rgba(255,73,160,0.08);transform:translateY(-1px);transition:box-shadow .18s}
.send-circle{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:34px;height:34px;border-radius:100px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent-a),var(--accent-b));border:none;cursor:pointer;box-shadow:0 16px 38px rgba(255,73,160,0.14);display:none;transition:transform .12s, box-shadow .18s, opacity .16s}
.input-wrap.ready .send-circle{display:flex}
.send-circle:hover{transform:translateY(-50%) scale(1.05);box-shadow:0 22px 48px rgba(255,73,160,0.22)}

/* footer & select */
.footer{display:flex;justify-content:space-between;align-items:center;gap:8px;padding-top:8px;color:var(--muted);font-size:12px}
.theme-select{background:rgba(0,0,0,0.45);color:#fff;border-radius:10px;padding:8px 10px;border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(10px);cursor:pointer;box-shadow:0 8px 26px rgba(255,73,160,0.06)}

/* responsive */
@media(max-width:900px){.app{grid-template-columns:1fr}.sidebar{order:2;height:160px}.panel{order:1;height:calc(100vh - 200px)}.user-bubble{max-width:70%}}
</style>
</head>
<body class="theme-pink">
  <div class="app">
    <aside class="sidebar">
      <header><strong>Conversations</strong><button class="new-btn" id="newConv">New</button></header>
      <div class="conv-list" id="convList"></div>
      <div style="margin-top:8px;font-size:12px;color:var(--muted)">Tip: click a convo to open. Use ⋯ to delete.</div>
    </aside>

    <main class="panel">
      <div class="header">
        <div class="brand"><img src="makala.png" alt="m"><h1 id="convTitle">makala.ai</h1></div>
        <div class="header-right">
          <button id="openSettings" style="background:transparent;border:0;cursor:pointer;"><img src="settings.png" width="18" height="18" alt="settings"></button>
          <select id="themeSelect" class="theme-select" title="Theme">
            <option value="pink">purple & pink</option>
            <option value="deep">deep black</option>
            <option value="soft">soft purple</option>
            <option value="blue">navy blue</option>
            <option value="orange">dark orange</option>
          </select>
        </div>
      </div>

      <div class="messages-wrap" id="messages"></div>

      <div class="input-area">
        <div class="input-wrap" id="inputWrap">
          <textarea id="input" class="input" placeholder="ask me anything..." rows="1" spellcheck="false"></textarea>
          <div class="send-circle" id="sendBtn"><img src="send-circle.png" width="18" height="18" alt="send"></div>
        </div>
      </div>

      <div class="footer">
        <div class="powered">powered by OpenRouter</div>
        <div>Model: <span id="modelName">default</span></div>
      </div>
    </main>
  </div>

<!-- settings modal -->
<div id="settingsModal" style="position:fixed;right:18px;bottom:72px;width:320px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);display:none;z-index:40;">
  <strong>Settings</strong>
  <div style="margin-top:8px">
    <label style="color:var(--muted)">Personality</label>
    <select id="personality" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff">
      <option value="makala">makala — playful</option>
      <option value="makala_serious">makala serious — concise</option>
    </select>
  </div>
  <div style="margin-top:8px">
    <label style="color:var(--muted)">Your name (optional)</label>
    <input id="userName" placeholder="Nickname" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff" />
  </div>
  <div style="display:flex;gap:8px;margin-top:10px;">
    <button id="saveSettings" class="new-btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px">Save</button>
    <button id="closeSettings" class="new-btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px">Close</button>
  </div>
</div>

<script>
/* ------------- small helpers ------------- */
const $ = s => document.querySelector(s);
const convListEl = $('#convList'), messagesWrap = $('#messages'), newConvBtn = $('#newConv'),
      convTitle = $('#convTitle'), input = $('#input'), inputWrap = $('#inputWrap'), sendBtn = $('#sendBtn'),
      themeSelect = $('#themeSelect'), settingsModal = $('#settingsModal'), openSettings = $('#openSettings'),
      saveSettings = $('#saveSettings'), closeSettings = $('#closeSettings'), personalityEl = $('#personality'),
      userNameEl = $('#userName');

function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8) }
function rtrimNewlines(s){ return String(s||'').replace(/\r/g,'').replace(/\n+$/,'') }
function sanitizeHTML(html){ return DOMPurify.sanitize(html) }

/* human-friendly relative time for conv list */
function relativeTime(ts){
  const now = Date.now();
  const diff = Math.max(0, Math.floor((now - ts)/1000)); // seconds
  if(diff < 60) return 'just now';
  if(diff < 3600){
    const m = Math.floor(diff/60); return `${m}m ago`;
  }
  // same-day detection
  const dNow = new Date(now); const dTs = new Date(ts);
  if(dNow.toDateString() === dTs.toDateString()) return 'Today';
  // yesterday
  const yesterday = new Date(now - 86400000);
  if(yesterday.toDateString() === dTs.toDateString()) return 'Yesterday';
  const days = Math.floor(diff/86400);
  if(days < 7) return `${days}d ago`;
  if(days < 30) return `${Math.floor(days/7)}w ago`;
  const years = Math.floor(days/365);
  if(years === 1) return 'A year ago';
  if(years >= 2) return 'A long time ago';
  // fallback months
  return `${Math.floor(days/30)}mo ago`;
}

/* ------------- storage & conversations ------------- */
let convs = JSON.parse(localStorage.getItem('makala_convs') || '[]'); if(!Array.isArray(convs)) convs = [];
let activeConvId = convs[0]?.id || null;
const settings = { personality: localStorage.getItem('makala_personality') || 'makala', userName: localStorage.getItem('makala_user') || '' };
if(settings.personality) personalityEl.value = settings.personality;
if(settings.userName) userNameEl.value = settings.userName;

function saveConvs(){ localStorage.setItem('makala_convs', JSON.stringify(convs)) }
function saveSettingsLocal(){ localStorage.setItem('makala_personality', settings.personality); localStorage.setItem('makala_user', settings.userName) }

function createConv(title='New conversation'){
  const c = { id: uid(), title: title || 'New conversation', created: Date.now(), messages: [], renderedCount: 0 };
  convs.unshift(c); saveConvs(); renderConvList(); setActiveConv(c.id, { clear:true, animate:false }); return c;
}
function deleteConv(id){
  const i = convs.findIndex(x=>x.id===id);
  if(i>=0) convs.splice(i,1);
  saveConvs(); renderConvList();
  if(convs.length) setActiveConv(convs[0].id, { clear:true, animate:false }); else createConv('New conversation');
}

/* ------------- render conversation list ------------- */
function renderConvList(){
  convListEl.innerHTML = '';
  convs.forEach(c=>{
    const el = document.createElement('div'); el.className = 'conv' + (c.id===activeConvId ? ' active' : ''); el.dataset.id = c.id;
    const time = relativeTime(c.created || Date.now());
    el.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
      <img src="makala.png" style="width:28px;height:28px;border-radius:6px" alt="">
      <div><div style="font-size:14px">${sanitizeHTML(c.title||'New conversation')}</div><div class="conv-meta">${time}</div></div>
    </div><div class="dots">⋯</div>`;
    convListEl.appendChild(el);
    el.addEventListener('click', (ev)=>{
      if(ev.target.closest('.dots')){ if(confirm('Delete this conversation?')) deleteConv(c.id); return; }
      setActiveConv(c.id, { clear:true, animate:false });
    });
  });
}

/* ------------- active conversation rendering ------------- */
function setActiveConv(id, opts={clear:false, animate:false}){
  activeConvId = id; renderConvList();
  const conv = convs.find(x=>x.id===id);
  if(!conv) return;
  convTitle.textContent = conv.title || 'makala.ai';
  if(opts.clear){ messagesWrap.innerHTML=''; conv.renderedCount = 0; }
  // incremental render: only append missing messages
  const start = conv.renderedCount || 0;
  for(let i=start;i<conv.messages.length;i++){
    appendMessageToDOM(conv, conv.messages[i], { animate: !!opts.animate && i === conv.messages.length-1 });
    conv.renderedCount = i+1;
  }
  // update conv timestamp (in list) visually
  renderConvList();
  messagesWrap.scrollTop = messagesWrap.scrollHeight;
}

/* ------------- message DOM helpers ------------- */
function appendMessageToDOM(conv, m, { animate=false } = {}){
  if(m.role === 'user'){
    const row = document.createElement('div'); row.className = 'row-user';
    const bubble = document.createElement('div'); bubble.className = 'user-bubble';
    bubble.textContent = rtrimNewlines(m.content || '');
    if(animate) bubble.classList.add('user-appear');
    const copy = document.createElement('img'); copy.src='copy.png'; copy.className='copy-user'; copy.title='copy'; copy.addEventListener('click', ()=> navigator.clipboard.writeText(m.content || ''));
    bubble.appendChild(copy);
    row.appendChild(bubble);
    messagesWrap.appendChild(row);
    messagesWrap.scrollTop = messagesWrap.scrollHeight;
    return;
  }

  // BOT: transparent "bubble" — inline copy appended after text
  const cont = document.createElement('div'); cont.className = 'bot-card';
  const meta = document.createElement('div'); meta.className = 'bot-meta';
  const small = document.createElement('img'); small.src='makala.png'; small.alt='m';
  const label = document.createElement('div'); label.className='bot-label'; label.textContent='makala ai';
  meta.appendChild(small); meta.appendChild(label);

  const body = document.createElement('div'); body.className = 'bot-body';
  cont.appendChild(meta); cont.appendChild(body);
  messagesWrap.appendChild(cont);
  messagesWrap.scrollTop = messagesWrap.scrollHeight;

  // insert inline copy node (kept in DOM but appended inside body at each update)
  const inlineCopy = document.createElement('img');
  inlineCopy.src = 'copy.png'; inlineCopy.className = 'bot-inline-copy'; inlineCopy.title = 'copy';
  inlineCopy.addEventListener('click', ()=> navigator.clipboard.writeText(m.content || ''));

  if(animate){
    // reveal progressively; keep inline copy appended each frame so its position stays after last char
    typeMarkdownIntoElement(rtrimNewlines(m.content || ''), body, inlineCopy);
  } else {
    // static render, append inline copy after content
    body.innerHTML = sanitizeAndTrim(marked.parse(rtrimNewlines(m.content || '')));
    renderMathInElement(body);
    attachCodeCopyButtons(body);
    // append copy inline at end of last text node without changing layout (inline-block)
    body.appendChild(inlineCopy);
  }
  messagesWrap.scrollTop = messagesWrap.scrollHeight;
}

/* sanitize and remove trailing empty blocks (fix phantom blank lines) */
function sanitizeAndTrim(html){
  const clean = DOMPurify.sanitize(html);
  // remove trailing empty tags like <p></p> or <div><br></div>
  const wrapper = document.createElement('div');
  wrapper.innerHTML = clean;
  // trim trailing empty nodes
  while(wrapper.lastChild && isEmptyNode(wrapper.lastChild)) wrapper.removeChild(wrapper.lastChild);
  return wrapper.innerHTML;
}
function isEmptyNode(node){
  if(!node) return true;
  if(node.nodeType === Node.TEXT_NODE) return !node.textContent.trim();
  if(node.nodeType === Node.ELEMENT_NODE){
    const tag = node.tagName.toLowerCase();
    if(tag === 'br') return true;
    if(!node.textContent.trim() && node.querySelectorAll('img,svg,code,pre').length === 0) return true;
  }
  return false;
}

/* ------------- markdown/math/code helpers ------------- */
function attachCodeCopyButtons(container){
  const pres = container.querySelectorAll('pre');
  pres.forEach(pre=>{
    if(pre.querySelector('.copy-code')) return;
    const btn = document.createElement('div'); btn.className='copy-code'; btn.title='copy';
    btn.innerHTML = `<img src="copy.png" width="14" height="14" alt="copy">`;
    btn.addEventListener('click', ()=> { const code = pre.querySelector('code'); if(code) navigator.clipboard.writeText(code.textContent); btn.style.opacity=.6; setTimeout(()=>btn.style.opacity=1,300); });
    pre.appendChild(btn);
  });
}

function renderMathInElement(el){
  // convert $...$ and $$...$$ placeholders into katex containers then render
  let html = el.innerHTML;
  html = html.replace(/\$\$([\s\S]+?)\$\$/g, (_, expr)=> `<span class="katex-display" data-katex="${encodeURIComponent(expr)}"></span>`);
  html = html.replace(/\$([^\$]+?)\$/g, (_, expr)=> `<span class="katex-inline" data-katex="${encodeURIComponent(expr)}"></span>`);
  el.innerHTML = html;
  const nodes = el.querySelectorAll('[data-katex]');
  nodes.forEach(node=>{
    const expr = decodeURIComponent(node.getAttribute('data-katex'));
    try{ katex.render(expr, node, { throwOnError:false, displayMode: node.classList.contains('katex-display') }); }
    catch(e){ node.textContent = expr; }
    node.removeAttribute('data-katex');
  });
}

/* per-character typing for NEW bot messages.
   We accept an inlineCopy node so it can be appended after content each frame. */
async function typeMarkdownIntoElement(text, container, inlineCopy){
  container.dataset.raw = text;
  container.innerHTML = '';
  const total = text.length || 1;
  const baseDelay = Math.max(4, Math.min(18, 120 / Math.sqrt(total)));
  // reveal char-by-char: build substring and parse markdown each frame
  for(let i=0;i<=text.length;i++){
    const sub = text.slice(0,i);
    const parsed = sanitizeAndTrim(marked.parse(sub));
    container.innerHTML = parsed;
    renderMathInElement(container);
    attachCodeCopyButtons(container);
    // append inline copy after content so it stays visually after last char
    if(inlineCopy && !container.contains(inlineCopy)) container.appendChild(inlineCopy);
    await new Promise(r=>setTimeout(r, baseDelay));
    messagesWrap.scrollTop = messagesWrap.scrollHeight;
  }
  // final render (ensure fully sanitized, math rendered and code buttons attached)
  container.innerHTML = sanitizeAndTrim(marked.parse(text));
  renderMathInElement(container);
  attachCodeCopyButtons(container);
  if(inlineCopy && !container.contains(inlineCopy)) container.appendChild(inlineCopy);
}

/* ------------- server comms ------------- */
async function sendToServer(payload){
  const resp = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!resp.ok) throw new Error(await resp.text());
  return resp.json();
}
function normalizeServerReply(data){
  if(!data) return '';
  if(typeof data === 'string') return data;
  if(data.reply && typeof data.reply === 'string') return data.reply;
  if(data.raw && data.raw.choices && data.raw.choices[0]){
    const c = data.raw.choices[0];
    return c.message?.content || c.text || '';
  }
  return String(data);
}

/* ------------- send flow (incremental, no reanim) ------------- */
async function handleSend(){
  const raw = input.value;
  const trimmed = rtrimNewlines(raw);
  if(!trimmed.trim()){
    input.classList.add('shake'); input.focus(); setTimeout(()=>input.classList.remove('shake'),360); return;
  }
  const conv = convs.find(c=>c.id===activeConvId);
  if(!conv) return;
  const userMsg = { role:'user', content: rtrimNewlines(raw), created: Date.now() };
  conv.messages.push(userMsg); saveConvs();
  appendMessageToDOM(conv, userMsg, { animate:true });
  input.value=''; autoResize(); inputWrap.classList.remove('ready');

  // insert placeholder typing element in UI (static)
  conv.messages.push({ role:'assistant', content:'', temp:true, created: Date.now() });
  saveConvs();
  const typingRow = document.createElement('div'); typingRow.className='bot-card'; typingRow.id='__typing_row';
  typingRow.innerHTML = `<div class="bot-meta"><img src="makala.png"><div class="bot-label">makala ai</div></div><div class="bot-body"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>`;
  messagesWrap.appendChild(typingRow); messagesWrap.scrollTop = messagesWrap.scrollHeight;

  // build payload: system + conv history (excluding temp)
  const payloadMsgs = [{ role:'system', content: systemPrompt() }, ...conv.messages.filter(m=>!m.temp).map(m=>({ role:m.role, content:m.content }))];
  try{
    const replyData = await sendToServer({ messages: payloadMsgs, model: (localStorage.getItem('makala_model')||'') || undefined });
    const replyText = normalizeServerReply(replyData) || 'no response.';
    // remove temp placeholders from conv.messages and push final assistant message
    conv.messages = conv.messages.filter(m=>!m.temp);
    const serverMsg = { role:'assistant', content: replyText, created: Date.now() };
    conv.messages.push(serverMsg); saveConvs();
    const tr = document.getElementById('__typing_row'); if(tr) tr.remove();
    appendMessageToDOM(conv, serverMsg, { animate:true });
    conv.renderedCount = conv.messages.length;
    renderConvList(); // update timestamps maybe
  }catch(err){
    console.error(err);
    const tr = document.getElementById('__typing_row'); if(tr) tr.remove();
    const errMsg = { role:'assistant', content: 'Error: ' + String(err), created: Date.now() };
    conv.messages = conv.messages.filter(m=>!m.temp); conv.messages.push(errMsg); saveConvs();
    appendMessageToDOM(conv, errMsg, { animate:true });
  }
}

/* ------------- system prompt (personality) ------------- */
function systemPrompt(){
  const base = (settings.personality === 'makala_serious')
    ? 'You are Makala (female). Speak professionally, concisely.'
    : `You are Makala (female). Speak casual internet slang, lowercase except the first word, playful tone, use 'lol','fr','so','like','bro', keep replies short (1-3 sentences), sometimes say 'beta'.`;
  const nameNote = settings.userName ? ` If you address the user call them ${settings.userName}.` : '';
  return base + nameNote;
}

/* ------------- UI interactions ------------- */
function autoResize(){ input.style.height='auto'; input.style.height = Math.min(input.scrollHeight, 200) + 'px' }
input.addEventListener('input', ()=> { autoResize(); const has = input.value.trim().length>0; if(has) inputWrap.classList.add('ready'); else inputWrap.classList.remove('ready'); });
input.addEventListener('keydown', (e)=> { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); } });
sendBtn.addEventListener('click', handleSend);

newConvBtn.addEventListener('click', ()=> createConv('New conversation'));
openSettings.addEventListener('click', ()=> settingsModal.style.display = (settingsModal.style.display === 'block' ? 'none' : 'block'));
closeSettings.addEventListener('click', ()=> settingsModal.style.display = 'none');
saveSettings.addEventListener('click', ()=> { settings.personality = personalityEl.value; settings.userName = userNameEl.value.trim(); saveSettingsLocal(); settingsModal.style.display='none'; });

document.addEventListener('click', (ev)=> {
  const c = ev.target.closest('.copy-code');
  if(c){ const pre = c.closest('pre'); const code = pre && pre.querySelector('code'); if(code) navigator.clipboard.writeText(code.textContent); }
});

/* ------------- init ------------- */
if(convs.length === 0) createConv('New conversation');
renderConvList();
if(!activeConvId) activeConvId = convs[0].id;
setActiveConv(activeConvId, { clear:true, animate:false });

// theme restore and apply (CSS variables handle most updates automatically)
(function initTheme(){ const t = localStorage.getItem('makala_theme') || 'pink'; document.body.className = 'theme-'+t; themeSelect.value = t; })();
themeSelect.addEventListener('change', (e)=> { document.body.className = 'theme-'+e.target.value; localStorage.setItem('makala_theme', e.target.value); });

// save conv timestamps on unload
window.addEventListener('beforeunload', ()=> saveConvs());
</script>
</body>
</html>
