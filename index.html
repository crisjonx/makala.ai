<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>makala.ai</title>
<link rel="icon" href="/makala.ico"/>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<style>
:root{
  --bg1:#0a0015;
  --bg2:#1b001f;
  --accent:#ff4fa0;
  --accent2:#ff7fcf;
}

body{
  margin:0;
  height:100vh;
  font-family:Inter,system-ui;
  background:
    radial-gradient(700px 500px at 10% 10%, rgba(255,79,160,.08), transparent),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
}

.chat-card{
  width:720px;
  max-width:95%;
  height:640px;
  display:flex;
  flex-direction:column;
  border-radius:16px;
  backdrop-filter:blur(14px);
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.05);
  box-shadow:0 20px 60px rgba(0,0,0,.6);
  overflow:hidden;
}

/* header */
.chat-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.chat-title{
  display:flex;
  align-items:center;
  gap:10px;
}
.chat-title img{
  width:28px;
  height:28px;
  filter:drop-shadow(0 0 8px var(--accent));
}
.chat-title h2{
  margin:0;
  font-size:16px;
}

/* messages */
.messages{
  flex:1;
  padding:16px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* rows */
.row{
  display:flex;
  align-items:flex-end;
  gap:8px;
}
.row.bot{align-items:flex-start}
.row.user{justify-content:flex-end}

/* avatars */
.avatar{
  width:26px;
  height:26px;
  border-radius:50%;
  flex-shrink:0;
  filter:drop-shadow(0 0 6px var(--accent));
}

/* bubbles */
.bubble{
  max-width:78%;
  padding:11px 14px;
  font-size:14.5px;
  line-height:1.45;
  word-break:break-word;
  animation:pop .16s ease-out forwards;
}
@keyframes pop{
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:none}
}

/* iMessage-style shapes */
.user .bubble{
  background:linear-gradient(90deg,#240025,#14001c);
  border-radius:18px 18px 6px 18px;
  color:#ffdff4;
}
.bot .bubble{
  background:rgba(255,255,255,.05);
  border-radius:18px 18px 18px 6px;
}

/* typing */
.typing{
  display:flex;
  gap:6px;
  padding:10px 12px;
}
.dot{
  width:7px;height:7px;
  border-radius:50%;
  background:rgba(255,255,255,.4);
  animation:blink 1s infinite;
}
.dot:nth-child(2){animation-delay:.15s}
.dot:nth-child(3){animation-delay:.3s}
@keyframes blink{
  0%{opacity:.2}
  50%{opacity:1}
  100%{opacity:.2}
}

/* input */
.input-row{
  display:flex;
  gap:10px;
  padding:12px;
  border-top:1px solid rgba(255,255,255,.06);
}
.input{
  flex:1;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
  padding:12px 14px;
  color:#fff;
  outline:none;
  transition:box-shadow .2s,transform .15s;
}
.input:focus{
  box-shadow:0 0 0 2px rgba(255,79,160,.25),
             0 0 24px rgba(255,79,160,.35);
  transform:translateY(-1px);
}

/* send */
.send{
  padding:12px 16px;
  border:none;
  border-radius:12px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:white;
  font-weight:700;
  cursor:pointer;
  transition:transform .15s,box-shadow .2s;
}
.send:hover{
  transform:translateY(-3px);
  box-shadow:0 14px 40px rgba(255,79,160,.4);
}

/* theme picker */
.theme-picker{
  position:fixed;
  right:18px;
  bottom:18px;
}
.theme-picker select{
  background:rgba(20,0,30,.7);
  color:white;
  border-radius:12px;
  padding:10px 14px;
  border:1px solid rgba(255,255,255,.08);
  backdrop-filter:blur(10px);
  cursor:pointer;
}

/* clear */
.clear{
  background:none;
  border:1px solid rgba(255,79,160,.3);
  color:var(--accent);
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="chat-card">

  <div class="chat-header">
    <div class="chat-title">
      <img src="/makala.png" alt="makala"/>
      <h2>makala.ai</h2>
    </div>
    <button id="clearBtn" class="clear">Clear chats</button>
  </div>

  <div id="messages" class="messages"></div>

  <div class="input-row">
    <input id="input" class="input" placeholder="ask me anything fr"/>
    <button id="sendBtn" class="send">send</button>
  </div>

</div>

<div class="theme-picker">
  <select id="themeSelect">
    <option value="pink">black / pink</option>
    <option value="deep">deep black</option>
    <option value="soft">soft purple</option>
  </select>
</div>

<script>
const messages = document.getElementById('messages');
const input = document.getElementById('input');

let history = JSON.parse(localStorage.getItem('makala_history')||'[]');

function save(){localStorage.setItem('makala_history',JSON.stringify(history))}

function bubble(text,who){
  const row=document.createElement('div');
  row.className='row '+who;

  if(who==='bot'){
    const a=document.createElement('img');
    a.src='/makala.png';
    a.className='avatar';
    row.appendChild(a);
  }

  const b=document.createElement('div');
  b.className='bubble';
  b.innerHTML=DOMPurify.sanitize(marked.parse(text));
  row.appendChild(b);

  messages.appendChild(row);
  messages.scrollTop=messages.scrollHeight;
}

if(history.length===0){
  bubble("hey im makala lol ask me anything fr","bot");
}else{
  history.forEach(m=>bubble(m.content,m.role==='assistant'?'bot':'user'));
}

async function send(){
  const t=input.value.trim();
  if(!t)return;
  bubble(t,'user');
  history.push({role:'user',content:t});
  save();
  input.value='';

  bubble(`<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`,'bot');

  const res=await fetch('/api/chat',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messages:history})
  });
  messages.lastChild.remove();

  const data=await res.json();
  bubble(data.reply,'bot');
  history.push({role:'assistant',content:data.reply});
  save();
}

document.getElementById('sendBtn').onclick=send;
input.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();send()}};

document.getElementById('clearBtn').onclick=()=>{
  history=[];
  save();
  messages.innerHTML='';
  bubble("hey im makala ask me anything fr","bot");
};

const themes={
  pink:['#0a0015','#1b001f'],
  deep:['#000','#080808'],
  soft:['#120018','#2a0030']
};
const themeSelect=document.getElementById('themeSelect');
themeSelect.onchange=()=>{
  const [a,b]=themes[themeSelect.value];
  document.documentElement.style.setProperty('--bg1',a);
  document.documentElement.style.setProperty('--bg2',b);
  localStorage.setItem('makala_theme',themeSelect.value);
};
const saved=localStorage.getItem('makala_theme')||'pink';
themeSelect.value=saved;
themeSelect.onchange();
</script>

</body>
</html>
