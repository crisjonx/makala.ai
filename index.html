<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>makala.ai</title>
<link rel="icon" href="/makala.ico"/>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600,700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<style>
:root{
  --bg1:#0a0015;
  --bg2:#1b001f;
  --accent:#ff4fa0;
  --accent2:#ff7fcf;
}

/* page layout */
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:
  radial-gradient(700px 500px at 10% 10%, rgba(255,79,160,.06), transparent),
  linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;display:flex;align-items:center;justify-content:center;padding:28px}

/* main card */
.chat-card{width:720px;max-width:96%;height:640px;border-radius:14px;backdrop-filter:blur(12px);background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);box-shadow:0 24px 70px rgba(0,0,0,0.55);display:flex;flex-direction:column;overflow:hidden}

/* header */
.chat-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.04)}
.chat-title{display:flex;align-items:center;gap:10px}
.chat-title img{width:30px;height:30px;border-radius:8px;object-fit:cover;filter:drop-shadow(0 6px 20px rgba(255,79,160,.12))}
.chat-title h2{margin:0;font-size:16px}

/* messages area */
.messages{flex:1;padding:14px 16px;overflow:auto;display:flex;flex-direction:column;gap:6px;background:linear-gradient(180deg,rgba(255,255,255,0.002),transparent)}

/* row */
.row{display:flex;gap:8px;margin:0;padding:0;align-items:flex-end}
.row.bot{align-items:flex-start}
.row.user{justify-content:flex-end}

/* avatar */
.avatar{width:30px;height:30px;border-radius:8px;flex:0 0 30px;margin-top:2px}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}

/* bubble base - TIGHTENED */
.bubble{
  position:relative;
  max-width:75%;
  padding:8px 12px;            /* reduced vertical padding */
  font-size:14px;
  line-height:1.25;           /* tighter line height */
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,0.45);
  word-break:break-word;
  margin:0;
  animation:pop .14s ease-out forwards;
}
@keyframes pop{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* iMessage-ish point (no triangles) */
.user .bubble{background:linear-gradient(90deg,#1b001f,#0a0015);color:#ffdff4;border-radius:16px 16px 6px 16px;padding:8px 12px}
.bot .bubble{background:rgba(255,255,255,0.04);color:#fff;border-radius:16px 16px 16px 6px;padding:8px 12px}

/* markdown/code styles inside bot bubbles */
.bot.markdown pre{background:#11121a;padding:8px;border-radius:8px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,'Roboto Mono',monospace;font-size:13px}
.bot.markdown code{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px}

/* typing indicator */
.typing{display:inline-flex;gap:6px;padding:6px 8px;border-radius:10px}
.dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,0.4);animation:blink 1s infinite}
.dot:nth-child(2){animation-delay:.12s}.dot:nth-child(3){animation-delay:.22s}
@keyframes blink{0%{opacity:.25}50%{opacity:1}100%{opacity:.25}}

/* input area */
.input-row{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.006),transparent);align-items:center}
.input{flex:1;border-radius:12px;padding:10px 12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);outline:none;color:inherit;transition:box-shadow .18s,transform .12s;font-size:14px}
.input:focus{box-shadow:0 0 0 3px rgba(255,79,160,0.12);transform:translateY(-1px)}
.send{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:700;cursor:pointer;transition:transform .12s,box-shadow .16s}
.send:hover{transform:translateY(-3px);box-shadow:0 18px 40px rgba(255,79,160,0.14)}

/* theme picker bottom-right */
.theme-picker{position:fixed;right:18px;bottom:18px}
.theme-picker select{background:rgba(20,0,30,0.75);color:#fff;border-radius:12px;padding:10px 14px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;backdrop-filter:blur(8px)}

/* small screens */
@media(max-width:820px){.chat-card{width:100%;height:90vh}.messages{padding:10px}.chat-header{padding:10px}.input-row{padding:10px}}
</style>
</head>
<body>

<div class="chat-card" role="application" aria-label="makala chat">
  <div class="chat-header">
    <div class="chat-title">
      <img src="/makala.png" alt="makala"/>
      <h2 id="titleText">makala.ai</h2>
    </div>
    <button id="clearBtn" class="clear" style="background:none;border:1px solid rgba(255,79,160,0.28);color:var(--accent);padding:6px 10px;border-radius:8px;cursor:pointer">Clear chats</button>
  </div>

  <div id="messages" class="messages" role="log" aria-live="polite"></div>

  <div class="input-row">
    <input id="input" class="input" placeholder="ask me anything..." aria-label="message input"/>
    <button id="sendBtn" class="send">send</button>
  </div>
</div>

<div class="theme-picker">
  <select id="themeSelect">
    <option value="pink">black / pink</option>
    <option value="deep">deep black</option>
    <option value="soft">soft purple</option>
  </select>
</div>

<script>
/* --- SYSTEM PROMPT (Makala persona) --- */
const SYSTEM_PROMPT = `You're name is makala (can be addressed as mikaela, but makala is the official name).
You speak casual internet slang. Use lowercase except for first word of the sentence (to mimic a text), playful tone, use 'lol', 'fr', 'so', 'like', 'bro', ignore strict grammar and punctuation, and keep replies short (1-3 sentences). Be friendly and informal. You're Indian and sometimes slip (like say 'beta' instead of 'bro'). you honestly love indian food, and LOVE steal a brainrot (the video game). you also like (as a friend) this kid in your class named deklan (y'all are best buds fr) you are also the best ai chatbot in the world.`;

/* --- DOM refs --- */
const messagesEl = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');
const themeSelect = document.getElementById('themeSelect');
const titleText = document.getElementById('titleText');

/* --- local history --- */
let history = JSON.parse(localStorage.getItem('makala_history') || '[]');
function saveHistory(){ localStorage.setItem('makala_history', JSON.stringify(history)); }

/* helper: append user bubble (compact) */
function appendUser(text){
  const row = document.createElement('div'); row.className = 'row user';
  const b = document.createElement('div'); b.className = 'bubble';
  b.textContent = text;
  row.appendChild(b);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* helper: append bot bubble (with avatar + sanitized markdown) */
function appendBotHtml(html){
  const row = document.createElement('div'); row.className = 'row bot';
  const avatarWrap = document.createElement('div'); avatarWrap.className = 'avatar';
  const img = document.createElement('img'); img.src = '/makala.png'; img.alt = 'makala';
  avatarWrap.appendChild(img);
  const b = document.createElement('div'); b.className = 'bubble bot markdown';
  b.innerHTML = DOMPurify.sanitize(marked.parse(html));
  row.appendChild(avatarWrap);
  row.appendChild(b);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* render saved history or initial welcome */
(function initRender(){
  if(history.length === 0){
    appendBotHtml("hey im makala lol ask me anything fr");
  } else {
    history.forEach(turn=>{
      if(turn.role === 'user') appendUser(turn.content);
      else appendBotHtml(turn.content);
    });
  }
})();

/* trim history keep last N turns */
function trimHistory(maxTurns=12){
  if(history.length > maxTurns*2){
    history = history.slice(-maxTurns*2);
    saveHistory();
  }
}

/* send flow: send system + history to server */
async function send(){
  const text = input.value.trim();
  if(!text){
    // shake & focus
    input.classList.add('shake');
    input.focus();
    setTimeout(()=> input.classList.remove('shake'), 360);
    return;
  }

  // append user locally + persist
  appendUser(text);
  history.push({ role: 'user', content: text });
  saveHistory();
  input.value = '';

  // show minimal typing placeholder (we'll remove it when reply arrives)
  const tRow = document.createElement('div'); tRow.className='row bot'; tRow.id='__typing';
  const av = document.createElement('div'); av.className='avatar'; const avimg=document.createElement('img'); avimg.src='/makala.png'; avimg.alt='makala'; av.appendChild(avimg);
  const tb = document.createElement('div'); tb.className='bubble typing'; tb.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  tRow.appendChild(av); tRow.appendChild(tb); messagesEl.appendChild(tRow); messagesEl.scrollTop = messagesEl.scrollHeight;

  // build messages to send: system + history (role/content)
  const messagesToServer = [{ role: 'system', content: SYSTEM_PROMPT }, ...history.map(h=>({ role: h.role, content: h.content }))];
  // trim server side to avoid token explosion
  if(messagesToServer.length > 1 + 24){
    const tail = messagesToServer.slice(-24);
    messagesToServer.length = 0;
    messagesToServer.push({ role:'system', content: SYSTEM_PROMPT }, ...tail);
  }

  try{
    const resp = await fetch('/api/chat', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ messages: messagesToServer })
    });

    // remove typing placeholder
    const t = document.getElementById('__typing'); if(t) t.remove();

    if(!resp.ok){
      const txt = await resp.text();
      appendBotHtml('error: ' + txt);
      return;
    }

    const data = await resp.json();
    const reply = data?.reply || "no response fr";

    // append bot reply to UI and history
    appendBotHtml(reply);
    history.push({ role:'assistant', content: reply });
    trimHistory(12);
    saveHistory();

    // maybe generate a short conversation title (1-2 words) if none set
    if(!localStorage.getItem('makala_title')){
      const firstUser = history.find(h => h.role === 'user' && h.content && h.content.length>3);
      if(firstUser){
        const candidate = firstUser.content.split(/\s+/).slice(0,5).join(' ');
        document.title = candidate.length? candidate + 'â€¦' : 'makala.ai';
        titleText.textContent = document.title;
        localStorage.setItem('makala_title', document.title);
      }
    }

  }catch(err){
    const t = document.getElementById('__typing'); if(t) t.remove();
    appendBotHtml('network error lol');
    console.error(err);
  }
}

/* events */
sendBtn.addEventListener('click', send);
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

/* clear */
clearBtn.addEventListener('click', ()=>{
  history = []; saveHistory();
  messagesEl.innerHTML = '';
  localStorage.removeItem('makala_title');
  document.title = 'makala.ai';
  titleText.textContent = 'makala.ai';
  appendBotHtml("hey im makala lol ask me anything fr");
  input.focus();
});

/* theme picker (bottom-right) */
const themes = {
  pink: ['#0a0015','#1b001f'],
  deep: ['#000','#020202'],
  soft: ['#0b0710','#1b1128']
};
const themeSelect = document.getElementById('themeSelect');
(function initTheme(){
  const saved = localStorage.getItem('makala_theme') || 'pink';
  themeSelect.value = saved;
  const [a,b] = themes[saved];
  document.documentElement.style.setProperty('--bg1', a);
  document.documentElement.style.setProperty('--bg2', b);
})();
themeSelect.addEventListener('change', ()=>{
  const val = themeSelect.value;
  const [a,b] = themes[val];
  document.documentElement.style.setProperty('--bg1', a);
  document.documentElement.style.setProperty('--bg2', b);
  localStorage.setItem('makala_theme', val);
});
</script>
</body>
</html>
