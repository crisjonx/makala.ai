<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>makala.ai</title>
<link rel="icon" href="/makala.ico" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<style>
/* reset */
* { box-sizing: border-box; }

/* theme vars */
:root{
  --bg1:#0a0015; --bg2:#1b001f;
  --accent-a:#ff49a0; --accent-b:#ff7fcf;
  --muted:#c0b3c9;
  --user-a:#1b001f; --user-b:#0a0015; --bot-bg: rgba(255,255,255,0.03);
}
body.theme-pink { --bg1:#0a0015; --bg2:#1b001f; --accent-a:#ff49a0; --accent-b:#ff7fcf; --user-a:#200023; --user-b:#0b0012; --bot-bg: rgba(255,255,255,0.03); }
body.theme-deep { --bg1:#030303; --bg2:#000000; --accent-a:#ff007f; --accent-b:#ff4fb1; --user-a:#0b0b0b; --user-b:#000000; --bot-bg: rgba(255,255,255,0.02); }
body.theme-soft { --bg1:#0b0710; --bg2:#1b1128; --accent-a:#b98cff; --accent-b:#8fb7ff; --user-a:#161023; --user-b:#0b0620; --bot-bg: rgba(255,255,255,0.035); }

html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
body{
  display:flex;align-items:center;justify-content:center;padding:28px;
  background:
    radial-gradient(700px 500px at 10% 10%, rgba(255,79,160,0.08), transparent),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  color:#fff;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
}

/* halo */
.halo{position:fixed;inset:-20%;z-index:0;filter:blur(88px);pointer-events:none;background:conic-gradient(from 180deg at 50% 50%, rgba(255,73,160,0.14), rgba(255,127,207,0.10), rgba(255,73,160,0.10));animation:rotate 12s linear infinite;opacity:.9}
@keyframes rotate{to{transform:rotate(360deg)}}

/* card */
.chat-card{position:relative;z-index:1;width:720px;max-width:100%;height:640px;display:flex;flex-direction:column;border-radius:14px;backdrop-filter:blur(12px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.005));box-shadow:0 14px 50px rgba(20,0,30,0.6);border:1px solid rgba(255,255,255,0.04);overflow:hidden}

/* header */
.chat-header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
.chat-title{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;border-radius:10px;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;position:relative;box-shadow:0 8px 28px rgba(255,73,160,0.12);border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,73,160,0.12), rgba(255,127,207,0.08));}
.logo img{width:100%;height:100%;object-fit:cover;display:block;transition:transform 220ms}
.logo:hover img{transform:scale(1.06)}
.chat-title h2{margin:0;font-size:16px;letter-spacing:0.2px}

/* header actions */
.header-actions{display:flex;gap:8px;align-items:center}

/* messages */
.messages{flex:1;padding:12px 16px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,rgba(255,255,255,0.002),transparent)}

/* row baseline alignment */
.row{display:flex;gap:10px;margin:0;padding:0;align-items:center}
.row.user{justify-content:flex-end}
.row.bot{justify-content:flex-start}

/* avatar */
.avatar{width:36px;height:36px;border-radius:8px;overflow:hidden;flex:0 0 36px;margin-top:0;align-self:center}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}

/* bubble styles */
.bubble{
  position:relative;
  box-sizing:border-box;
  display:block;
  max-width:74%;
  padding:10px 14px;
  border-radius:14px;
  line-height:1.25;
  font-size:14px;
  box-shadow:0 6px 18px rgba(20,0,30,0.6);
  word-break:break-word;
  margin:0;
  border:1px solid rgba(255,255,255,0.03);
  min-height:38px;
  white-space: pre-wrap;
  animation:pop .18s cubic-bezier(.2,.9,.27,1) both;
}
@keyframes pop{0%{opacity:0;transform:translateY(8px) scale(.985)}60%{opacity:1;transform:translateY(-2px) scale(1.01)}100%{opacity:1;transform:translateY(0) scale(1)}}

/* corner shapes */
.user .bubble{ background:linear-gradient(90deg,var(--user-a),var(--user-b)); color:#ffdff4; border-radius:18px 18px 6px 18px; }
.bot .bubble{ background:var(--bot-bg); color:#fff; border-radius:18px 18px 18px 6px; }

/* --- Key fix: normalize markdown block elements so they don't add unexpected spacing --- */
/* Make paragraphs and blocks behave like stacked inline-blocks with no margins */
.bot.markdown p,
.bot.markdown div,
.bot.markdown pre,
.bot.markdown ul,
.bot.markdown ol,
.bot.markdown blockquote,
.bot.markdown h1,
.bot.markdown h2,
.bot.markdown h3 {
  display: inline-block;
  width: 100%;
  margin: 0;
  padding: 0;
  vertical-align: top;
  white-space: pre-wrap; /* preserve linebreaks inside paragraphs */
}

/* also ensure code blocks behave */
.bot.markdown pre { padding:8px; background:#11121a; border-radius:8px; overflow:auto; font-family:ui-monospace, Menlo, Monaco, 'Roboto Mono', monospace; font-size:13px; }

/* ensure inline <p> inside bubble have no margin */
.bubble p{ margin:0; padding:0; }

/* typing */
.typing{display:inline-flex;gap:8px;padding:6px 8px;border-radius:10px;align-items:center}
.dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.36);animation:blink 1s infinite}
.dot:nth-child(2){animation-delay:.12s}.dot:nth-child(3){animation-delay:.24s}
@keyframes blink{0%{opacity:.25}50%{opacity:1}100%{opacity:.25}}

/* input area (textarea for shift+enter) */
.input-row{display:flex;gap:12px;padding:12px;border-top:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);align-items:center}
textarea.input{
  flex:1; min-height:44px; max-height:220px; resize:none;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
  border-radius:12px;padding:10px 12px;border:1px solid rgba(255,255,255,0.04);
  outline:none;color:inherit;font-size:15px;transition:box-shadow 180ms, transform 120ms;
  line-height:1.25; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
}
textarea.input:focus{box-shadow:0 8px 30px rgba(255,73,160,0.14);transform:translateY(-1px)}
.input-glow{position:relative}
.input-glow::after{content:"";position:absolute;inset:-6px;border-radius:14px;background:linear-gradient(90deg,var(--accent-a),var(--accent-b));opacity:0;filter:blur(12px);transition:opacity 160ms;pointer-events:none;z-index:-1}
textarea.input:focus + .input-glow::after{opacity:.28}

/* buttons */
.btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:transform 120ms, box-shadow 140ms, opacity 120ms}
.send{background:linear-gradient(90deg,var(--accent-a),var(--accent-b));color:white;box-shadow:0 10px 26px rgba(255,73,160,0.08)}
.send:hover{transform:translateY(-3px);box-shadow:0 18px 40px rgba(255,73,160,0.14)}
.clear{background:transparent;color:var(--accent-a);border:1px solid rgba(255,73,160,0.12)}
.clear:hover{background:rgba(255,73,160,0.04);transform:translateY(-2px)}

/* shake */
@keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}100%{transform:translateX(0)}}
.shake{animation:shake 360ms cubic-bezier(.36,.07,.19,.97)}

/* theme picker */
.theme-picker{position:fixed;right:18px;bottom:18px;z-index:30}
.theme-picker select{background:rgba(20,0,30,0.7);color:white;border-radius:12px;padding:10px 14px;border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(10px);cursor:pointer;box-shadow:0 12px 30px rgba(255,73,160,0.08);transition:transform .12s}
.theme-picker select:hover{transform:translateY(-3px)}

/* final safety: force equal spacing */
.user .bubble, .bot .bubble {
  padding: 10px 14px !important;
  line-height: 1.25 !important;
  font-size: 14px !important;
  min-height: 38px !important;
  box-sizing: border-box !important;
}

/* responsive */
@media(max-width:880px){
  .chat-card{width:calc(100% - 32px);height:84vh}
  .messages{padding:10px}
  .logo{width:34px;height:34px}
  .avatar{display:none}
}
</style>
</head>
<body class="theme-pink">
  <div class="halo" aria-hidden="true"></div>

  <div class="chat-card" role="application" aria-label="Makala chat">
    <div class="chat-header">
      <div class="chat-title">
        <div class="logo" aria-hidden><img src="makala.png" alt="makala" /></div>
        <h2 id="titleText">makala.ai</h2>
      </div>

      <div class="header-actions">
        <button id="clearBtn" class="btn clear" title="Clear chat history">Clear chats</button>
      </div>
    </div>

    <div id="messages" class="messages" role="log" aria-live="polite"></div>

    <div class="input-row">
      <textarea id="input" class="input" placeholder="ask me anything..." aria-label="message input" rows="1"></textarea>
      <span class="input-glow" aria-hidden></span>
      <button id="sendBtn" class="btn send" aria-label="send message">send</button>
    </div>
  </div>

  <div class="theme-picker">
    <select id="themeSelect" aria-label="Theme">
      <option value="pink">purple & pink</option>
      <option value="deep">deep black</option>
      <option value="soft">soft purple</option>
    </select>
  </div>

<script>
/* Persona */
const SYSTEM_PROMPT = `You're name is makala (can be addressed as mikaela, but makala is the official name).
You speak casual internet slang. Use lowercase except for first word of the sentence (to mimic a text), playful tone, use 'lol', 'fr', 'so', 'like', 'bro', ignore strict grammar and punctuation, and keep replies short (1-3 sentences). Be friendly and informal. You're Indian and sometimes slip (like say 'beta' instead of 'bro'). you honestly love indian food, and LOVE steal a brainrot (the video game).`;

/* DOM */
const messagesEl = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');
const themeSelect = document.getElementById('themeSelect');
const titleText = document.getElementById('titleText');

/* history */
let history = JSON.parse(localStorage.getItem('makala_history') || '[]');
function saveHistory(){ localStorage.setItem('makala_history', JSON.stringify(history)); }
function saveTheme(t){ localStorage.setItem('makala_theme', t); }
function saveTitle(t){ localStorage.setItem('makala_title', t); }

/* restore saved title if present */
(function restoreTitle(){
  const savedTitle = localStorage.getItem('makala_title');
  if(savedTitle){
    document.title = savedTitle;
    titleText.textContent = savedTitle;
  } else {
    document.title = 'makala.ai';
    titleText.textContent = 'makala.ai';
  }
})();

/* helper: trim trailing newlines only (keep internal newlines) */
function rtrimNewlines(s){
  return String(s || '').replace(/\r/g,'').replace(/\n+$/,'');
}

/* append user bubble */
function appendUserBubble(text){
  const cleaned = rtrimNewlines(text);
  const row = document.createElement('div'); row.className = 'row user';
  const bubble = document.createElement('div'); bubble.className = 'bubble';
  bubble.textContent = cleaned;
  row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* append bot bubble (markdown sanitized). We also rtrim to avoid trailing blank paragraphs */
function appendBotBubbleHtml(html){
  const cleaned = rtrimNewlines(html);
  const row = document.createElement('div'); row.className = 'row bot';
  const avatar = document.createElement('div'); avatar.className = 'avatar';
  const img = document.createElement('img'); img.src = 'makala.png'; img.alt = 'makala';
  avatar.appendChild(img);

  const bubble = document.createElement('div'); bubble.className = 'bubble bot markdown';
  bubble.innerHTML = DOMPurify.sanitize(marked.parse(cleaned));
  row.appendChild(avatar); row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return bubble;
}

/* typing indicator */
function showTyping(){
  const row = document.createElement('div'); row.className = 'row bot'; row.id='__typing_row';
  const avatar = document.createElement('div'); avatar.className = 'avatar';
  const img = document.createElement('img'); img.src='makala.png'; img.alt='makala';
  avatar.appendChild(img);
  const bubble = document.createElement('div'); bubble.className = 'bubble bot typing'; bubble.id='__typing';
  bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  row.appendChild(avatar); row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function removeTyping(){ const t = document.getElementById('__typing_row'); if(t) t.remove(); }

/* render saved history or welcome */
(function renderSavedHistory(){
  if(history.length === 0){
    appendBotBubbleHtml("hi guys im makala ai ask me anything");
  } else {
    history.forEach(turn => {
      if(turn.role === 'user') appendUserBubble(turn.content);
      else appendBotBubbleHtml(turn.content);
    });
  }
})();

/* trim history */
function trimHistory(maxTurns = 12){
  if(history.length > maxTurns * 2){
    history = history.slice(-maxTurns*2);
    saveHistory();
  }
}

/* sentence split for reveal */
function splitIntoSentences(text){
  const re = /[^.!?]+[.!?]*|\s+$/g;
  const matches = text.match(re) || [];
  return matches.map(s => s.trim()).filter(Boolean);
}

/* reveal bot reply sentence-by-sentence (uses rtrim to avoid phantom trailing newlines) */
async function revealReplyBySentence(rawReplyText){
  const replyText = rtrimNewlines(rawReplyText);
  removeTyping();
  const row = document.createElement('div'); row.className = 'row bot';
  const avatar = document.createElement('div'); avatar.className = 'avatar';
  const img = document.createElement('img'); img.src = 'makala.png'; img.alt = 'makala';
  avatar.appendChild(img);
  const bubble = document.createElement('div'); bubble.className = 'bubble bot markdown';
  row.appendChild(avatar); row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  const sentences = splitIntoSentences(replyText);
  let accumulated = '';
  for (let i = 0; i < sentences.length; i++){
    const s = sentences[i];
    const delay = Math.min(1200, 300 + s.length * 14);
    accumulated += (accumulated ? ' ' : '') + s;
    bubble.innerHTML = DOMPurify.sanitize(marked.parse(rtrimNewlines(accumulated)));
    messagesEl.scrollTop = messagesEl.scrollHeight;
    await new Promise(r => setTimeout(r, delay));
  }
  return bubble;
}

/* title helper: produce a short Title case snippet */
function titleFromText(s){
  if(!s) return null;
  const cleaned = s.replace(/[?!.]+$/,'').trim();
  const words = cleaned.split(/\s+/).filter(Boolean).slice(0,5);
  if(words.length === 0) return null;
  const title = words.join(' ');
  return title.charAt(0).toUpperCase() + title.slice(1);
}

/* generate title from first or second usable user message and save it */
function generateTitleIfNeeded(){
  if(localStorage.getItem('makala_title')) return;
  const userMessages = history.filter(h => h.role === 'user' && h.content && h.content.trim().length > 0);
  const usable = userMessages.filter(u => u.content.trim().length > 3);
  if(usable.length === 0) return;
  let candidateText = usable[0].content.trim();
  if(candidateText.split(/\s+/).length <= 2 && usable.length >= 2){
    candidateText = usable[1].content.trim();
  }
  const title = titleFromText(candidateText);
  if(title){
    document.title = title;
    titleText.textContent = title;
    saveTitle(title);
  }
}

/* maybe generate title after user sends */
function maybeGenerateTitleAfterUser(){ generateTitleIfNeeded(); }

/* theme handling */
function applyTheme(which){
  document.body.classList.remove('theme-deep','theme-pink','theme-soft');
  if(which === 'deep') document.body.classList.add('theme-deep');
  else if(which === 'soft') document.body.classList.add('theme-soft');
  else document.body.classList.add('theme-pink');
  saveTheme(which);
}
/* init theme */
(function initTheme(){ const saved = localStorage.getItem('makala_theme') || 'pink'; themeSelect.value = saved; applyTheme(saved); })();
themeSelect.addEventListener('change', ()=> applyTheme(themeSelect.value));

/* send flow â€” Enter sends, Shift+Enter newline */
async function send(){
  const rawValue = input.value.replace(/\r/g,'');
  const trimmedForCheck = rtrimNewlines(rawValue).trim();
  if(!trimmedForCheck){
    input.classList.add('shake'); input.focus(); setTimeout(()=> input.classList.remove('shake'), 360); return;
  }

  const storedUserContent = rtrimNewlines(rawValue);
  history.push({ role:'user', content: storedUserContent });
  saveHistory();
  appendUserBubble(storedUserContent);
  input.value = '';
  input.style.height = '';

  maybeGenerateTitleAfterUser();

  const messages = [{ role:'system', content: SYSTEM_PROMPT }, ...history.map(h => ({ role: h.role, content: h.content }))];
  if(messages.length > 1 + 24){
    const tail = messages.slice(-24);
    messages.length = 0;
    messages.push({ role:'system', content: SYSTEM_PROMPT }, ...tail);
  }

  showTyping();
  sendBtn.disabled = true;

  try {
    const resp = await fetch('/api/chat', {
      method:'POST',
      headers:{ 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages })
    });

    if(!resp.ok){
      const err = await resp.text();
      removeTyping(); sendBtn.disabled = false;
      appendBotBubbleHtml('error: ' + err);
      return;
    }

    const data = await resp.json();
    const replyRaw = (data?.reply || 'no response lol').replace(/\r/g,'');
    const reply = rtrimNewlines(replyRaw);

    history.push({ role:'assistant', content: reply });
    trimHistory(12);
    saveHistory();

    await revealReplyBySentence(reply);

  } catch (e) {
    removeTyping(); sendBtn.disabled = false;
    appendBotBubbleHtml('network error lol');
    console.error(e);
  } finally {
    removeTyping(); sendBtn.disabled = false;
  }
}

/* auto-resize textarea */
function autoResizeTextarea(el){ el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
input.addEventListener('input', ()=> autoResizeTextarea(input));

/* keyboard: Enter sends, Shift+Enter newline */
input.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

/* events */
sendBtn.addEventListener('click', send);

/* clear chats */
clearBtn.addEventListener('click', () => {
  history = []; saveHistory();
  messagesEl.innerHTML = '';
  localStorage.removeItem('makala_title'); // remove saved title
  document.title = 'makala.ai';
  titleText.textContent = 'makala.ai';
  appendBotBubbleHtml("hi guys im makala ai ask me anything");
  input.focus();
});

/* set default if no saved title present */
if (!localStorage.getItem('makala_title')) { document.title = 'makala.ai'; }
</script>
</body>
</html>
