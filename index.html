<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>makala.ai</title>
<link rel="icon" href="/makala.ico" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<style>
:root{
  --bg1:#0a0015; --bg2:#1b001f;
  --accent-a:#ff49a0; --accent-b:#ff7fcf;
  --muted:#c0b3c9;
  --glass: rgba(255,255,255,0.03);
  --bot-tail-color: rgba(255,255,255,0.03); /* approximate bot bubble edge */
  --user-tail-color: #0a0015; /* dark user tail */
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
body{display:flex;align-items:center;justify-content:center;padding:32px;background:radial-gradient(600px 400px at 10% 10%, rgba(255,73,160,0.08), transparent),radial-gradient(600px 400px at 90% 90%, rgba(255,127,207,0.06), transparent), linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

/* THEMES as before (kept) */
body.theme-deep { --bg1:#000000; --bg2:#030303; --accent-a:#ff007f; --accent-b:#ff4fb1; --muted:#9b98a6; }
body.theme-pink { --bg1:#0a0015; --bg2:#1b001f; --accent-a:#ff49a0; --accent-b:#ff7fcf; --muted:#c0b3c9; }
body.theme-soft { --bg1:#0b0710; --bg2:#1b1128; --accent-a:#b98cff; --accent-b:#8fb7ff; --muted:#bfc7d6; }

/* halo */
.halo{position:fixed;inset:-20%;z-index:0;filter:blur(88px);pointer-events:none;background:conic-gradient(from 180deg at 50% 50%, rgba(255,73,160,0.16), rgba(255,127,207,0.12), rgba(255,73,160,0.12));animation:rotate 12s linear infinite;opacity:.9}
@keyframes rotate{to{transform:rotate(360deg)}}

/* card */
.chat-card{position:relative;z-index:1;width:720px;max-width:100%;height:640px;display:flex;flex-direction:column;border-radius:14px;backdrop-filter:blur(12px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.005));box-shadow:0 14px 50px rgba(20,0,30,0.6);border:1px solid rgba(255,255,255,0.04);overflow:hidden}

/* header */
.chat-header{padding:14px 16px;background:linear-gradient(90deg, rgba(255,73,160,0.03), rgba(255,127,207,0.02));border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;gap:12px}
.chat-title{display:flex;align-items:center;gap:12px}
.chat-title h2{margin:0;font-size:16px;letter-spacing:0.2px;display:inline-block}

/* logo */
.logo { width:40px;height:40px;border-radius:10px;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;position:relative;box-shadow:0 8px 28px rgba(255,73,160,0.12);border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,73,160,0.12), rgba(255,127,207,0.08));}
.logo img{width:100%;height:100%;object-fit:cover;display:block;transition:transform 220ms}
.logo:hover img{transform:scale(1.06)}
.logo::after{content:"";position:absolute;left:-18px;top:-18px;right:-18px;bottom:-18px;border-radius:18px;background:radial-gradient(closest-side, rgba(255,73,160,0.18), rgba(255,127,207,0.06));filter:blur(18px);opacity:0;transition:opacity 220ms, transform 400ms;transform:scale(0.95);pointer-events:none}
.logo:hover::after{opacity:0.45;transform:scale(1.02);animation:glowPulse 2.6s ease-in-out infinite}
@keyframes glowPulse{0%{opacity:0.25;transform:scale(0.98)}50%{opacity:0.45;transform:scale(1.02)}100%{opacity:0.25;transform:scale(0.98)}}

/* header actions & theme buttons */
.header-actions{display:flex;gap:8px;align-items:center}
.theme-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
.theme-btn.active{border-color:rgba(255,255,255,0.12);box-shadow:0 10px 22px rgba(0,0,0,0.6);color:#fff}

/* messages - tightened spacing */
.messages{flex:1;padding:12px 16px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,rgba(255,255,255,0.002),transparent)}

/* row container - align items bottom for user, top for bot to keep avatar aligned naturally */
.row{display:flex;gap:10px;margin:0;padding:0;align-items:flex-end} 
.row.bot{align-items:flex-start} /* avatar sits at top of bubble */
.row.user{justify-content:flex-end}

/* avatar */
.avatar{width:36px;height:36px;border-radius:8px;overflow:hidden;flex:0 0 36px;margin-top:4px}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}

/* bubble basics */
.bubble{position:relative;max-width:74%;padding:12px 14px;border-radius:14px;line-height:1.45;box-shadow:0 6px 18px rgba(20,0,30,0.6);background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);color:#fff;word-break:break-word;margin:0}
/* user bubble dark */
.user .bubble{background:linear-gradient(90deg,#1b001f,#0a0015);border:1px solid rgba(255,255,255,0.03);color:#ffdff4;border-bottom-right-radius:6px;border-bottom-left-radius:14px;border-top-left-radius:14px;border-top-right-radius:14px}
/* bot bubble light */
.bot .bubble{border-bottom-left-radius:6px;border-bottom-right-radius:14px;border-top-left-radius:14px;border-top-right-radius:14px}

/* tails: bot (left) and user (right) */
/* BOT tail (left) */
.bot .bubble::after{
  content: "";
  position: absolute;
  left: -8px;
  top: 12px;
  width: 0;
  height: 0;
  border: 8px solid transparent;
  border-right-color: var(--bot-tail-color);
  filter: drop-shadow(0 1px 0 rgba(0,0,0,0.15));
  transform: translateX(-1px);
  border-radius: 1px;
  z-index: 1;
}
/* A small inner layer to match bubble border & give a rounded look */
.bot .bubble::before{
  content: "";
  position: absolute;
  left: -6px;
  top: 11px;
  width: 0;
  height: 0;
  border: 6px solid transparent;
  border-right-color: rgba(255,255,255,0.01);
  transform: translateX(-1px);
  z-index: 0;
}

/* USER tail (right) */
.user .bubble::after{
  content: "";
  position: absolute;
  right: -8px;
  top: 12px;
  width: 0;
  height: 0;
  border: 8px solid transparent;
  border-left-color: var(--user-tail-color);
  transform: translateX(1px);
  z-index: 1;
}
.user .bubble::before{
  content: "";
  position: absolute;
  right: -6px;
  top: 11px;
  width: 0;
  height: 0;
  border: 6px solid transparent;
  border-left-color: #0c0911;
  transform: translateX(1px);
  z-index: 0;
}

/* markdown & code styling kept */
.bot.markdown pre{background:#1b001f;padding:10px;border-radius:8px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,'Roboto Mono',monospace;font-size:13px}
.bot.markdown code{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px}

/* typing */
.typing{display:inline-flex;gap:6px;padding:8px 10px;border-radius:10px}
.dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.35);animation:blink 1s infinite}
.dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
@keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}

/* input area */
.input-row{display:flex;gap:12px;padding:12px;border-top:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);align-items:center}
.input{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:12px;padding:12px 14px;border:1px solid rgba(255,255,255,0.04);outline:none;color:inherit;font-size:15px;transition:box-shadow 180ms, transform 120ms}
.input:focus{box-shadow:0 8px 30px rgba(255,73,160,0.14);transform:translateY(-1px)}
.input-glow{position:relative}
.input-glow::after{content:"";position:absolute;inset:-6px;border-radius:14px;background:linear-gradient(90deg,var(--accent-a),var(--accent-b));opacity:0;filter:blur(12px);transition:opacity 160ms;pointer-events:none;z-index:-1}
.input:focus + .input-glow::after{opacity:.28}
.input:focus::placeholder{color:transparent}

/* buttons */
.btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:transform 120ms, box-shadow 140ms, opacity 120ms}
.send{background:linear-gradient(90deg,var(--accent-a),var(--accent-b));color:white;box-shadow:0 10px 26px rgba(255,73,160,0.08)}
.send:hover{transform:translateY(-3px);box-shadow:0 18px 40px rgba(255,73,160,0.14)}
.send:active{transform:translateY(0)}
.clear{background:transparent;color:var(--accent-a);border:1px solid rgba(255,73,160,0.12)}
.clear:hover{background:rgba(255,73,160,0.04);transform:translateY(-2px)}

/* shake animation for empty send */
@keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}100%{transform:translateX(0)}}
.shake{animation:shake 360ms cubic-bezier(.36,.07,.19,.97)}

/* small screen */
@media(max-width:780px){.chat-card{width:100%;height:90vh}.chat-header{padding:12px}.input-row{padding:10px}.avatar{display:none}}
</style>
</head>
<body>
  <div class="halo" aria-hidden></div>

  <div class="chat-card" role="application" aria-label="Makala chat">
    <div class="chat-header">
      <div class="chat-title">
        <div class="logo" aria-hidden>
          <img src="makala.png" alt="makala" />
        </div>
        <h2 id="titleText">makala.ai</h2>
      </div>

      <div class="header-actions">
        <button id="themeDeep" class="theme-btn" title="Deep black">Deep</button>
        <button id="themePink" class="theme-btn active" title="Black / Pink">Pink</button>
        <button id="themeSoft" class="theme-btn" title="Soft purple">Soft</button>
        <button id="clearBtn" class="btn clear" title="Clear chat history">Clear chats</button>
      </div>
    </div>

    <div id="messages" class="messages" role="log" aria-live="polite"></div>

    <div class="input-row">
      <input id="input" class="input" placeholder="ask me anything..." aria-label="message input" />
      <span class="input-glow" aria-hidden></span>
      <button id="sendBtn" class="btn send" aria-label="send message">send</button>
    </div>
  </div>

<script>
/* client-side history + localStorage + server forwarding of full messages */
/* Features: sentence-by-sentence reveal, empty-send shake+focus, theme switch, convo title generation, bot avatar */
const messagesEl = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');
const titleText = document.getElementById('titleText');

const themeDeep = document.getElementById('themeDeep');
const themePink = document.getElementById('themePink');
const themeSoft = document.getElementById('themeSoft');

// system prompt
const SYSTEM_PROMPT = `You're name is makala or makala ai (can be addressed as mikaela, macaroni, or miku, but makala is the official name).
You speak casual internet slang. Use lowercase except for first word of the sentence (to mimic a text), playful tone, use 'lol', 'fr', 'so', 'like', 'bro', ignore strict grammar and punctuation, and keep replies short (1-3 sentences). Be friendly and informal. You're Indian and sometimes slip (like say 'beta' instead of 'bro'). you honestly love indian food, and LOVE steal a brainrot (the video game). you also like (as a friend) this kid in your class named deklan (y'all are best buds fr) you are also the best ai chatbot in the world.`;

// local history (array of {role:'user'|'assistant', content})
let history = JSON.parse(localStorage.getItem('makala_history') || '[]');

// restore theme
const savedTheme = localStorage.getItem('makala_theme') || 'pink';
applyTheme(savedTheme);

// restore tab title if saved
const savedTitle = localStorage.getItem('makala_title');
if (savedTitle) {
  document.title = savedTitle;
  titleText.textContent = savedTitle;
}

// helpers
function saveHistory(){ localStorage.setItem('makala_history', JSON.stringify(history)); }
function saveTheme(t){ localStorage.setItem('makala_theme', t); }
function saveTitle(t){ localStorage.setItem('makala_title', t); }

function appendUserBubble(text){
  const row = document.createElement('div'); row.className = 'row user';
  const bubble = document.createElement('div'); bubble.className = 'bubble';
  bubble.textContent = text;
  row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function appendBotBubbleHtml(html){
  // create a bot row with avatar + bubble containing HTML (sanitized)
  const row = document.createElement('div'); row.className = 'row bot';
  const avatar = document.createElement('div'); avatar.className = 'avatar';
  const img = document.createElement('img'); img.src = 'makala.png'; img.alt = 'makala';
  avatar.appendChild(img);
  const bubble = document.createElement('div'); bubble.className = 'bubble bot';
  bubble.innerHTML = DOMPurify.sanitize(html);
  row.appendChild(avatar);
  row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return bubble; // return bubble element so caller can append more
}

function showTyping(){
  const row = document.createElement('div'); row.className = 'row bot';
  row.id = '__typing_row';
  const avatar = document.createElement('div'); avatar.className = 'avatar';
  const img = document.createElement('img'); img.src = 'makala.png'; img.alt = 'makala';
  avatar.appendChild(img);
  const bubble = document.createElement('div'); bubble.className = 'bubble bot typing'; bubble.id='__typing';
  bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  row.appendChild(avatar); row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function removeTyping(){ const tRow = document.getElementById('__typing_row'); if(tRow) tRow.remove(); }

// render saved history or welcome
(function renderSavedHistory(){
  if(history.length === 0){
    appendBotBubbleHtml("hey im makala lol ask me anything fr");
  } else {
    history.forEach(turn => {
      if(turn.role === 'user') appendUserBubble(turn.content);
      else appendBotBubbleHtml(turn.content);
    });
  }
})();

// trim history
function trimHistory(maxTurns = 12){
  if(history.length > maxTurns * 2){
    history = history.slice(-maxTurns*2);
    saveHistory();
  }
}

/* SENTENCE-BY-SENTENCE REVEAL */
function splitIntoSentences(text){
  const re = /[^.!?]+[.!?]*|\s+$/g;
  const matches = text.match(re) || [];
  return matches.map(s => s.trim()).filter(Boolean);
}

async function revealReplyBySentence(replyText){
  removeTyping();

  const row = document.createElement('div'); row.className = 'row bot';
  const avatar = document.createElement('div'); avatar.className = 'avatar';
  const img = document.createElement('img'); img.src = 'makala.png'; img.alt = 'makala';
  avatar.appendChild(img);
  const bubble = document.createElement('div'); bubble.className = 'bubble bot markdown';
  row.appendChild(avatar); row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  const sentences = splitIntoSentences(replyText);

  let accumulated = '';
  for (let i = 0; i < sentences.length; i++){
    const s = sentences[i];
    const delay = Math.min(1200, 350 + s.length * 18);
    accumulated += (accumulated ? ' ' : '') + s;
    const html = marked.parse(accumulated);
    bubble.innerHTML = DOMPurify.sanitize(html);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    await new Promise(r => setTimeout(r, delay));
  }

  return bubble;
}

// CONVERSATION TITLE GENERATION
function maybeGenerateTitle(){
  if (localStorage.getItem('makala_title')) return;
  const userMessages = history.filter(h => h.role === 'user' && h.content.trim().length > 3);
  if (userMessages.length >= 2){
    const candidate = userMessages[0].content.split(/\s+/).slice(0,6).join(' ');
    const title = candidate.length ? (candidate + 'â€¦') : 'makala.ai';
    document.title = title;
    titleText.textContent = title;
    saveTitle(title);
  }
}

// THEME HANDLING
function applyTheme(which){
  document.body.classList.remove('theme-deep','theme-pink','theme-soft');
  if(which === 'deep') document.body.classList.add('theme-deep');
  else if(which === 'soft') document.body.classList.add('theme-soft');
  else document.body.classList.add('theme-pink');
  themeDeep.classList.toggle('active', which==='deep');
  themePink.classList.toggle('active', which==='pink');
  themeSoft.classList.toggle('active', which==='soft');
  saveTheme(which);
}
themeDeep.addEventListener('click', ()=>applyTheme('deep'));
themePink.addEventListener('click', ()=>applyTheme('pink'));
themeSoft.addEventListener('click', ()=>applyTheme('soft'));
(function initTheme(){ const t = localStorage.getItem('makala_theme') || 'pink'; applyTheme(t); })();

// send flow
async function send(){
  const text = input.value.trim();
  if(!text){
    input.classList.add('shake');
    input.focus();
    setTimeout(()=> input.classList.remove('shake'), 360);
    return;
  }

  history.push({ role:'user', content: text });
  saveHistory();
  appendUserBubble(text);
  input.value = '';

  const messages = [{ role:'system', content: SYSTEM_PROMPT }, ...history.map(h => ({ role: h.role, content: h.content }))];
  if(messages.length > 1 + 24){
    const tail = messages.slice(-24);
    messages.length = 0;
    messages.push({ role:'system', content: SYSTEM_PROMPT }, ...tail);
  }

  showTyping();
  sendBtn.disabled = true;

  try {
    const resp = await fetch('/api/chat', {
      method:'POST',
      headers:{ 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages })
    });

    if(!resp.ok){
      const err = await resp.text();
      removeTyping(); sendBtn.disabled = false;
      appendBotBubbleHtml('error: ' + err);
      return;
    }

    const data = await resp.json();
    const reply = data?.reply || 'no response lol';

    history.push({ role:'assistant', content: reply });
    trimHistory(12);
    saveHistory();

    await revealReplyBySentence(reply);
    maybeGenerateTitle();

  } catch (e) {
    removeTyping(); sendBtn.disabled = false;
    appendBotBubbleHtml('network error lol');
  } finally {
    removeTyping();
    sendBtn.disabled = false;
  }
}

// events
sendBtn.addEventListener('click', send);
input.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

// Clear chats
clearBtn.addEventListener('click', () => {
  history = [];
  saveHistory();
  messagesEl.innerHTML = '';
  localStorage.removeItem('makala_title');
  document.title = 'makala.ai';
  titleText.textContent = 'makala.ai';
  appendBotBubbleHtml("hey im makala lol ask me anything fr");
  input.focus();
});

// initial title
if (!localStorage.getItem('makala_title')) { document.title = 'makala.ai'; }
</script>
</body>
</html>
